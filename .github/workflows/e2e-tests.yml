name: Checkout E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - cart
          - payment
          - tax
          - order
          - shipping
          - voucher
          - smoke
      browser:
        description: 'Browser to test'
        required: false
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - electron
      tags:
        description: 'Grep tags (e.g. @p1, @stripe)'
        required: false
        default: ''

env:
  CYPRESS_BASE_URL: ${{ secrets.STAGING_BASE_URL }}
  CYPRESS_API_BASE_URL: ${{ secrets.STAGING_API_BASE_URL }}
  CYPRESS_SHOPIFY_STRIPE_API_KEY: ${{ secrets.SHOPIFY_STRIPE_API_KEY }}
  CYPRESS_SHOPIFY_ADYEN_API_KEY: ${{ secrets.SHOPIFY_ADYEN_API_KEY }}
  CYPRESS_SHOPIFY_MOLLIE_API_KEY: ${{ secrets.SHOPIFY_MOLLIE_API_KEY }}
  CYPRESS_WOOCOMMERCE_STRIPE_API_KEY: ${{ secrets.WOOCOMMERCE_STRIPE_API_KEY }}
  CYPRESS_MAGENTO_STRIPE_API_KEY: ${{ secrets.MAGENTO_STRIPE_API_KEY }}

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Verify Cypress
        run: npx cypress verify

      - name: Typecheck
        run: npm run typecheck

      - name: Lint
        run: npm run lint

  e2e-tests:
    needs: install
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        suite:
          - { name: 'cart', spec: 'cypress/e2e/cart/**' }
          - { name: 'payment', spec: 'cypress/e2e/payment/**' }
          - { name: 'tax', spec: 'cypress/e2e/tax/**' }
          - { name: 'order', spec: 'cypress/e2e/order/**' }
          - { name: 'shipping', spec: 'cypress/e2e/shipping/**' }
          - { name: 'voucher', spec: 'cypress/e2e/voucher/**' }
          - { name: 'integration', spec: 'cypress/e2e/integration/**' }
          - { name: 'regression', spec: 'cypress/e2e/regression/**' }

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Restore Cypress cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Run ${{ matrix.suite.name }} tests
        uses: cypress-io/github-action@v6
        with:
          browser: ${{ github.event.inputs.browser || 'chrome' }}
          spec: ${{ matrix.suite.spec }}
          install: false
        env:
          CYPRESS_grepTags: ${{ github.event.inputs.tags || '' }}

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.suite.name }}
          path: cypress/screenshots
          retention-days: 7

      - name: Upload Mochawesome report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.suite.name }}
          path: mochawesome-report
          retention-days: 14

  merge-reports:
    needs: e2e-tests
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - run: npm ci

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          pattern: report-*
          path: all-reports
          merge-multiple: true

      - name: Merge Mochawesome reports
        run: |
          npx mochawesome-merge all-reports/**/*.json > merged-report.json
          npx marge merged-report.json -f final-report -o final-report

      - name: Upload merged report
        uses: actions/upload-artifact@v4
        with:
          name: final-e2e-report
          path: final-report
          retention-days: 30
